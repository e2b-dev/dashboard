openapi: "3.0.0"

info:
  version: 0.1.0
  title: E2B Dashboard API

components:
  securitySchemes:
    Supabase1TokenAuth:
      type: apiKey
      in: header
      name: X-Supabase-Token
    Supabase2TeamAuth:
      type: apiKey
      in: header
      name: X-Supabase-Team

  parameters:
    build_id:
      name: build_id
      in: path
      required: true
      description: Identifier of the build.
      schema:
        type: string
        format: uuid
    sandboxID:
      name: sandboxID
      in: path
      required: true
      description: Identifier of the sandbox.
      schema:
        type: string
    builds_limit:
      name: limit
      in: query
      required: false
      description: Maximum number of items to return per page.
      schema:
        type: integer
        format: int32
        minimum: 1
        maximum: 100
        default: 50
    builds_cursor:
      name: cursor
      in: query
      required: false
      description: Cursor returned by the previous list response in `created_at|build_id` format.
      schema:
        type: string
    build_id_or_template:
      name: build_id_or_template
      in: query
      required: false
      description: Optional filter by build identifier, template identifier, or template alias.
      schema:
        type: string
    build_statuses:
      name: statuses
      in: query
      required: false
      description: Comma-separated list of build statuses to include.
      style: form
      explode: false
      schema:
        type: array
        items:
          $ref: "#/components/schemas/BuildStatus"
    build_ids:
      name: build_ids
      in: query
      required: true
      description: Comma-separated list of build IDs to get statuses for.
      style: form
      explode: false
      schema:
        type: array
        items:
          type: string
          format: uuid
        maxItems: 100
        uniqueItems: true

  responses:
    "400":
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "401":
      description: Authentication error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "403":
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "404":
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    "500":
      description: Server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"

  schemas:
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          format: int32
          description: Error code.
        message:
          type: string
          description: Error message.

    BuildStatus:
      type: string
      description: Build status mapped for dashboard clients.
      enum:
        - building
        - failed
        - success

    ListedBuild:
      type: object
      required:
        - id
        - template
        - templateId
        - status
        - statusMessage
        - createdAt
        - finishedAt
      properties:
        id:
          type: string
          format: uuid
          description: Identifier of the build.
        template:
          type: string
          description: Template alias when present, otherwise template ID.
        templateId:
          type: string
          description: Identifier of the template.
        status:
          $ref: "#/components/schemas/BuildStatus"
        statusMessage:
          type: string
          nullable: true
          description: Failure message when status is `failed`, otherwise `null`.
        createdAt:
          type: string
          format: date-time
          description: Build creation timestamp in RFC3339 format.
        finishedAt:
          type: string
          format: date-time
          nullable: true
          description: Build completion timestamp in RFC3339 format, if finished.

    BuildsListResponse:
      type: object
      required:
        - data
        - nextCursor
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/ListedBuild"
        nextCursor:
          type: string
          nullable: true
          description: Cursor to pass to the next list request, or `null` if there is no next page. 

    BuildStatusItem:
      type: object
      required:
        - id
        - status
        - finishedAt
        - statusMessage
      properties:
        id:
          type: string
          format: uuid
          description: Identifier of the build.
        status:
          $ref: "#/components/schemas/BuildStatus"
        finishedAt:
          type: string
          format: date-time
          nullable: true
          description: Build completion timestamp in RFC3339 format, if finished.
        statusMessage:
          type: string
          nullable: true
          description: Failure message when status is `failed`, otherwise `null`.

    BuildsStatusesResponse:
      type: object
      required:
        - buildStatuses
      properties:
        buildStatuses:
          type: array
          description: List of build statuses
          items:
            $ref: "#/components/schemas/BuildStatusItem"

    BuildInfo:
      type: object
      required:
        - createdAt
        - finishedAt
        - status
        - statusMessage
      properties:
        names:
          type: array
          items:
            type: string
          nullable: true
          description: Template names related to this build, if available.
        createdAt:
          type: string
          format: date-time
          description: Build creation timestamp in RFC3339 format.
        finishedAt:
          type: string
          format: date-time
          nullable: true
          description: Build completion timestamp in RFC3339 format, if finished.
        status:
          $ref: "#/components/schemas/BuildStatus"
        statusMessage:
          type: string
          nullable: true
          description: Failure message when status is `failed`, otherwise `null`.

    CPUCount:
      type: integer
      format: int32
      minimum: 1
      description: CPU cores for the sandbox

    MemoryMB:
      type: integer
      format: int32
      minimum: 128
      description: Memory for the sandbox in MiB

    DiskSizeMB:
      type: integer
      format: int32
      minimum: 0
      description: Disk size for the sandbox in MiB

    SandboxRecord:
      type: object
      required:
        - templateID
        - sandboxID
        - startedAt
        - cpuCount
        - memoryMB
        - diskSizeMB
      properties:
        templateID:
          type: string
          description: Identifier of the template from which is the sandbox created
        alias:
          type: string
          description: Alias of the template
        sandboxID:
          type: string
          description: Identifier of the sandbox
        startedAt:
          type: string
          format: date-time
          description: Time when the sandbox was started
        stoppedAt:
          type: string
          format: date-time
          nullable: true
          description: Time when the sandbox was stopped
        domain:
          type: string
          nullable: true
          description: Base domain where the sandbox traffic is accessible
        cpuCount:
          $ref: "#/components/schemas/CPUCount"
        memoryMB:
          $ref: "#/components/schemas/MemoryMB"
        diskSizeMB:
          $ref: "#/components/schemas/DiskSizeMB"

    HealthResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Human-readable health check result.

tags:
  - name: builds
  - name: sandboxes

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: Health check successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /builds:
    get:
      summary: List team builds
      tags: [builds]
      security:
        - Supabase1TokenAuth: []
          Supabase2TeamAuth: []
      parameters:
        - $ref: "#/components/parameters/build_id_or_template"
        - $ref: "#/components/parameters/build_statuses"
        - $ref: "#/components/parameters/builds_limit"
        - $ref: "#/components/parameters/builds_cursor"
      responses:
        "200":
          description: Successfully returned paginated builds.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BuildsListResponse"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "500":
          $ref: "#/components/responses/500"

  /builds/statuses:
    get:
      summary: Get build statuses
      tags: [builds]
      security:
        - Supabase1TokenAuth: []
          Supabase2TeamAuth: []
      parameters:
        - $ref: "#/components/parameters/build_ids"

      responses:
        "200":
          description: Successfully returned build statuses
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BuildsStatusesResponse"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "500":
          $ref: "#/components/responses/500"

  /builds/{build_id}:
    get:
      summary: Get build details
      tags: [builds]
      security:
        - Supabase1TokenAuth: []
          Supabase2TeamAuth: []
      parameters:
        - $ref: "#/components/parameters/build_id"
      responses:
        "200":
          description: Successfully returned build details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BuildInfo"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "500":
          $ref: "#/components/responses/500"

  /sandboxes/{sandboxID}/record:
    get:
      summary: Get sandbox record
      tags: [sandboxes]
      security:
        - Supabase1TokenAuth: []
          Supabase2TeamAuth: []
      parameters:
        - $ref: "#/components/parameters/sandboxID"
      responses:
        "200":
          description: Successfully returned sandbox details.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SandboxRecord"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "500":
          $ref: "#/components/responses/500"
